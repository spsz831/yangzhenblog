---
import PublicLayout from "@/layouts/PublicLayout.astro";
import { getDb } from "@/db";
import { posts } from "@/db/schema";
import { desc, eq, lte, and, like, or } from "drizzle-orm";
import { format } from "date-fns";
import { Card, CardHeader, CardTitle, CardContent, CardFooter } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { CalendarIcon, Search } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { tags, postsToTags } from "@/db/schema";

const db = getDb(Astro.locals.runtime.env.DB);
const q = Astro.url.searchParams.get("q") || "";

const whereClause = and(
  eq(posts.status, 'published'),
  lte(posts.publishedAt, new Date()),
  q ? or(like(posts.title, `%${q}%`), like(posts.content, `%${q}%`)) : undefined
);

const publishedPosts = await db.select().from(posts)
  .where(whereClause)
  .orderBy(desc(posts.publishedAt)).all();

const allTags = await db.select().from(tags).all();
const allPostTags = await db.select().from(postsToTags).all();

const tagsMap = new Map<number, typeof tags.$inferSelect[]>();
allPostTags.forEach(pt => {
    if (!tagsMap.has(pt.postId)) tagsMap.set(pt.postId, []);
    const tag = allTags.find(t => t.id === pt.tagId);
    if (tag) tagsMap.get(pt.postId)!.push(tag);
});
---

<PublicLayout title="博客">
  <section class="container max-w-6xl py-6 lg:py-10">
    <div class="flex flex-col items-start gap-4 md:flex-row md:justify-between md:gap-8">
      <div class="flex-1 space-y-4">
        <h1 class="inline-block font-heading text-4xl tracking-tight lg:text-5xl">
          最新文章
        </h1>
        <p class="text-xl text-muted-foreground">
          分享技术、生活和思考。
        </p>
      </div>
      <form action="/posts" method="GET" class="flex items-center gap-2">
        <div class="relative">
          <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
          <Input
            type="search"
            name="q"
            placeholder="搜索文章..."
            className="pl-9 w-[200px] md:w-[300px]"
            defaultValue={q}
          />
        </div>
      </form>
    </div>
    <hr class="my-8" />
    
    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-2">
      {publishedPosts.map((post) => (
        <a href={`/posts/${post.slug}`} class="group transition-all hover:scale-[1.01]">
          <Card className="h-full flex flex-col overflow-hidden border-muted-foreground/20 hover:border-primary/50 transition-colors">
            <CardHeader>
              <CardTitle className="line-clamp-2 text-xl group-hover:text-primary transition-colors">
                {post.title}
              </CardTitle>
            </CardHeader>
            <CardContent className="flex-1">
              <p class="text-muted-foreground line-clamp-3 text-sm leading-relaxed">
                {post.excerpt || "暂无摘要"}
              </p>
            </CardContent>
            <CardFooter className="flex items-center justify-between text-sm text-muted-foreground">
              <div class="flex items-center gap-2">
                <CalendarIcon className="h-4 w-4" />
                <span>{post.publishedAt ? format(post.publishedAt, "yyyy年MM月dd日") : ""}</span>
              </div>
              <div class="flex gap-2">
                 {tagsMap.get(post.id)?.map(tag => (
                    <Badge variant="secondary" className="font-normal text-xs">#{tag.name}</Badge>
                 ))}
              </div>
            </CardFooter>
          </Card>
        </a>
      ))}
    </div>
    
    {publishedPosts.length === 0 && (
      <div class="py-12 text-center">
        <p class="text-muted-foreground text-lg">暂无文章。</p>
      </div>
    )}
  </section>
</PublicLayout>
