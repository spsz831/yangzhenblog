---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { getDb } from "@/db";
import { users } from "@/db/schema";
import { eq } from "drizzle-orm";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Separator } from "@/components/ui/separator";

export const prerender = false;

const session = Astro.cookies.get("admin_session");
if (!session || !session.value) {
  return Astro.redirect("/admin/login");
}

const userId = parseInt(session.value);
const db = getDb(Astro.locals.runtime.env.DB);
const user = await db.select().from(users).where(eq(users.id, userId)).get();

if (!user) {
  return Astro.redirect("/admin/login");
}

const error = Astro.url.searchParams.get("error");
const success = Astro.url.searchParams.get("success");
---

<AdminLayout title="账号设置">
  <div class="space-y-6">
    <div>
      <h3 class="text-lg font-medium">账号设置</h3>
      <p class="text-sm text-muted-foreground">
        管理您的个人资料和账户安全。
      </p>
    </div>
    <Separator />

    {error && (
      <div class="bg-destructive/15 text-destructive text-sm p-3 rounded-md">
        {error === "wrong_password" && "旧密码错误"}
        {error === "password_mismatch" && "两次输入的新密码不一致"}
        {error === "update_failed" && "更新失败，请重试"}
      </div>
    )}

    {success && (
      <div class="bg-green-100 text-green-800 text-sm p-3 rounded-md">
        {success === "profile_updated" && "个人资料已更新"}
        {success === "password_updated" && "密码已修改"}
      </div>
    )}

    <div class="grid gap-6">
      <Card>
        <CardHeader>
          <CardTitle>个人资料</CardTitle>
          <CardDescription>
            更新您的公开信息。
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form action="/api/admin/settings" method="POST" class="space-y-4">
            <input type="hidden" name="action" value="update_profile" />
            <div class="grid gap-2">
              <Label htmlFor="nickname">昵称</Label>
              <Input id="nickname" name="nickname" defaultValue={user.nickname || ""} placeholder="您的昵称" />
            </div>
            <div class="grid gap-2">
              <Label htmlFor="email">邮箱</Label>
              <Input id="email" name="email" type="email" defaultValue={user.email} required />
            </div>
            <div class="grid gap-2">
              <Label htmlFor="avatar">头像 URL</Label>
              <Input id="avatar" name="avatar" defaultValue={user.avatar || ""} placeholder="https://..." />
            </div>
            <Button type="submit">保存资料</Button>
          </form>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>修改密码</CardTitle>
          <CardDescription>
            为了安全起见，请定期更换密码。
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form action="/api/admin/settings" method="POST" class="space-y-4">
            <input type="hidden" name="action" value="change_password" />
            <div class="grid gap-2">
              <Label htmlFor="current_password">当前密码</Label>
              <Input id="current_password" name="current_password" type="password" required />
            </div>
            <div class="grid gap-2">
              <Label htmlFor="new_password">新密码</Label>
              <Input id="new_password" name="new_password" type="password" required />
            </div>
            <div class="grid gap-2">
              <Label htmlFor="confirm_password">确认新密码</Label>
              <Input id="confirm_password" name="confirm_password" type="password" required />
            </div>
            <Button type="submit">修改密码</Button>
          </form>
        </CardContent>
      </Card>
    </div>
  </div>
</AdminLayout>
