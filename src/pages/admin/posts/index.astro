---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { getDb } from "@/db";
import { posts } from "@/db/schema";
import { desc, eq } from "drizzle-orm";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { PostFilterTabs } from "@/components/admin/PostFilterTabs";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { format } from "date-fns";
import { Plus } from "lucide-react";

export const prerender = false;

const status = Astro.url.searchParams.get("status") || "all";

const db = getDb(Astro.locals.runtime.env.DB);

let query = db.select().from(posts).orderBy(desc(posts.createdAt));

if (status !== "all") {
  // @ts-ignore
  query = db.select().from(posts).where(eq(posts.status, status)).orderBy(desc(posts.createdAt));
}

const allPosts = await query.all();
---

<AdminLayout title="文章列表">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold tracking-tight">文章列表</h2>
    <Button asChild>
      <a href="/admin/posts/new">
        <Plus className="mr-2 h-4 w-4" />
        新建文章
      </a>
    </Button>
  </div>

  <div class="mb-6">
    <PostFilterTabs defaultValue={status} client:load />
  </div>

  <div class="rounded-md border">
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>标题</TableHead>
          <TableHead>状态</TableHead>
          <TableHead>发布时间</TableHead>
          <TableHead className="text-right">操作</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {allPosts.map((post) => (
          <TableRow key={post.id}>
            <TableCell className="font-medium">{post.title}</TableCell>
            <TableCell>
              <Badge variant={post.status === 'published' ? 'default' : (post.status === 'scheduled' ? 'secondary' : 'outline')}>
                {post.status === 'published' ? '已发布' : (post.status === 'scheduled' ? '定时发布' : '草稿')}
              </Badge>
            </TableCell>
            <TableCell>
              {post.publishedAt ? format(post.publishedAt, "yyyy-MM-dd HH:mm") : "-"}
            </TableCell>
            <TableCell className="text-right">
              <Button variant="ghost" size="sm" asChild>
                <a href={`/admin/posts/${post.id}/edit`}>编辑</a>
              </Button>
            </TableCell>
          </TableRow>
        ))}
        {allPosts.length === 0 && (
          <TableRow>
            <TableCell colSpan={4} className="h-24 text-center">
              暂无文章
            </TableCell>
          </TableRow>
        )}
      </TableBody>
    </Table>
  </div>
</AdminLayout>
