---
import AdminLayout from "@/layouts/AdminLayout.astro";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardHeader, CardTitle, CardDescription, CardContent, CardFooter } from "@/components/ui/card";
import { getDb } from "@/db";
import { users } from "@/db/schema";
import { eq } from "drizzle-orm";

export const prerender = false;

const session = Astro.cookies.get("admin_session");
if (!session || !session.value) {
  return Astro.redirect("/admin/login");
}
const userId = parseInt(session.value);

const db = getDb(Astro.locals.runtime.env.DB);
const user = await db.select().from(users).where(eq(users.id, userId)).get();

if (!user) {
  return Astro.redirect("/admin/login");
}

const error = Astro.url.searchParams.get("error");
const success = Astro.url.searchParams.get("success");
---

<AdminLayout title="账号设置">
  <div class="space-y-6">
    <div>
      <h2 class="text-3xl font-bold tracking-tight">账号设置</h2>
      <p class="text-muted-foreground">
        管理您的个人资料和安全设置
      </p>
    </div>

    {error && (
      <div class="bg-destructive/15 text-destructive px-4 py-3 rounded-md text-sm">
        {error === 'missing_fields' && '请填写所有必填项'}
        {error === 'password_mismatch' && '两次输入的密码不一致'}
        {error === 'wrong_password' && '当前密码错误'}
      </div>
    )}

    {success && (
      <div class="bg-green-500/15 text-green-600 px-4 py-3 rounded-md text-sm">
        {success === 'profile_updated' && '个人资料已更新'}
        {success === 'password_updated' && '密码已修改'}
      </div>
    )}

    <div class="grid gap-6 md:grid-cols-2">
      <!-- Profile Settings -->
      <Card>
        <CardHeader>
          <CardTitle>个人资料</CardTitle>
          <CardDescription>
            更新您的公开信息
          </CardDescription>
        </CardHeader>
        <form action="/api/admin/settings" method="POST">
          <input type="hidden" name="action" value="update_profile" />
          <CardContent className="space-y-4">
            <div class="space-y-2">
              <Label htmlFor="username">用户名</Label>
              <Input id="username" name="username" defaultValue={user.username} required />
            </div>
            <div class="space-y-2">
              <Label htmlFor="nickname">昵称</Label>
              <Input id="nickname" name="nickname" defaultValue={user.nickname || ''} />
            </div>
            <div class="space-y-2">
              <Label htmlFor="email">邮箱</Label>
              <Input id="email" name="email" type="email" defaultValue={user.email} required />
            </div>
            <div class="space-y-2">
              <Label htmlFor="avatar">头像 URL</Label>
              <Input id="avatar" name="avatar" defaultValue={user.avatar || ''} placeholder="https://..." />
            </div>
          </CardContent>
          <CardFooter>
            <Button type="submit">保存更改</Button>
          </CardFooter>
        </form>
      </Card>

      <!-- Password Settings -->
      <Card>
        <CardHeader>
          <CardTitle>修改密码</CardTitle>
          <CardDescription>
            为了安全起见，请定期更换密码
          </CardDescription>
        </CardHeader>
        <form action="/api/admin/settings" method="POST">
          <input type="hidden" name="action" value="change_password" />
          <CardContent className="space-y-4">
            <div class="space-y-2">
              <Label htmlFor="current_password">当前密码</Label>
              <Input id="current_password" name="current_password" type="password" required />
            </div>
            <div class="space-y-2">
              <Label htmlFor="new_password">新密码</Label>
              <Input id="new_password" name="new_password" type="password" required />
            </div>
            <div class="space-y-2">
              <Label htmlFor="confirm_password">确认新密码</Label>
              <Input id="confirm_password" name="confirm_password" type="password" required />
            </div>
          </CardContent>
          <CardFooter>
            <Button type="submit">修改密码</Button>
          </CardFooter>
        </form>
      </Card>
    </div>
  </div>
</AdminLayout>
